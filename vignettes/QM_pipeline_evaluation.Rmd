---
title: "QM_pipeline_evaluation"
output:
pdf_document:   
latex_engine: lualatex
vignette: >
  %\VignetteIndexEntry{QM_pipeline_evaluation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# QM konforme (Re-)Evaluierung von Assemblies und Prüfmethoden

Dieses Dokument beschreibt das Vorgehen bei der (Re-)Evaluierung der bioinformatischen Prozessketten (sog. Pipelines). Dies ist relevant für die folgenden Anweisungen:

-   SOP P 32.6 0004 01_Assemblierung von „Short-Read“-Sequenzdaten zur Rekonstruktion von Bakteriengenomen

-   PRM 0 32.6 0003 01_Genotypisierung Salmonella enterica Genomsequenzdaten FASTA

-   PRM 0 32.6 0004 01_Genotypisierung E. coli

-   PRM 0 32.6 0005 01_Genotypisierung Listeria monocytogenes

-   PRM 0 32.6 0006 01_Genotypisierung Staph aureus

-   PRM 0 32.6 0007 01_Genotypisierung Legionella pneumophila

Das folgende Dokument beschreibt das Vorgehen zur Erstellung der Evaluierungsauswertung wie für die jeweiligen Anhänge "Beispielhafte Doku Prozessvalidierung.pdf" gefordert.

Rohdaten (fastq-Dateien) liegen schreibgeschützt auf dem Linux-Server des Instituts (SRVLDAP0008) und bilden die Grundlage für die Validierung. Wir laden hierfür in R zunächst das Paket `luaRlp`, außerdem benötigen wir zur hier beschriebenen Datenanalyse das Paket `dplyr`:

```{r loadlib}
library(luaRlp)
library(dplyr)
```

Wir werden im weiteren Verlauf die folgende Funktion nutzen:

```{r message=FALSE, warning=FALSE}
Re_Eval <- RIDOM_comptable_re_evaluate(
  old_folder = 
    "O:/Abteilung Humanmedizin (AHM)/Referat 32/32_6/13_QM/Validierung Pipeline/2025_03_19/",
  new_folder = 
    "O:/Abteilung Humanmedizin (AHM)/Referat 32/32_6/13_QM/Validierung Pipeline/2025_03_20/")
```

1.   `old_folder` bezeichnet einen Ordner in dem Tabellen als **.csv-Dateien** aus der vorherigen Evaluierung abgelegt sind. Der Ordner wurde mit dem Datum im Format (JJJJ_MM_DD) benannt. Wir notieren den Pfad dieses Ordners. Die Funktion des Pakets wird sicherstellen, dass er die geforderten Dateien ("Comparison tables") enthält.

2.  Wir stellen sicher, dass die Evaluierungs-Proben nicht bereits in prozessiert in RIDOM Seqsphere vorleigen (sie 4. unten) und kopieren nun die Rohdaten für die Evaluierung auf dem Linux Server in einen Ordner, der von der zu evaluierenden Pipeline in RIDOM Seqsphere überwacht wird. Dadurch werden die Proben prozessiert.

3.  Nachdem die Prozessierung abgeschlossen ist exportieren wir in RIDOM Seqsphere "*Comparison Tables*" für die Projekte "*Produktiv_Salmonellea_enterica*", "*Produktiv_EHEC*", "*Produktiv_Listeria_moncytogenes*", "*Produktiv_MRSA*" und "*Produktiv_Legionella_pneumophila*". Wir speichern diese in einem anderen Ordner (nun mit dem aktuelle Datum im Format JJJJ_MM_DD -\> `new_folder`). Bei der nächsten Re-Evaluierung werden diese "Comparison tables" als Referenz benutzt, im aktuellen Prozess werden sie als `new_folder` angegeben.

4.  Wir löschen nun die Evaluierungs-Proben aus RIDOM Seqsphere um eine Re-Prozessierung bei der nächsten Re-Prozessierung in der Zukunft zu ermöglichen.

Als Standardwert für den Output-Ordner (`out_folder`) nutzt die Funktion `"O:/Abteilung Humanmedizin (AHM)/Referat 32/32_6/13_QM/Validierung Pipeline/Vergleiche/"`. Darüber hinaus ist im Standardwert der Funktion hinterlegt, dass hierin ein Unterordner aus dem Zusammenziehen der Namen der beiden verglichenen Ordner generiert wird, dieser Order erhält außerdem einen Zeitstempel der aktuellen Re-Evaluierung. Im hier gezeigten Beispiel wird `2025_03_19_VS_2025_03_20_timestamp` als Ordnername erstellt. Dieser Standardwert ist in der QM-konformen Re-Evaluierung nicht zu ändern.

Die Funktion überschreibt aus Sicherheitsgründen keine Dateien, sonder gibt einen Fehler aus, sollte der Nutzer dies verlangen (durch den minutengenauen Zeitstempel ist dies für den Standartwert praktisch ausgeschlossen).

Dateien wurden von der oben gezeigten Funktion in den angegebenen Output-Ordner geschrieben. Zusätzlich gibt die Funktion eine Liste von tibbles ("tidyverse-Tabellen") zurück. Diese kann nun auch direkt in R analysiert werden:

```{r echo=TRUE}

Re_Eval["EHEC"]

Re_Eval[["EHEC"]] |>
  dplyr::select(where(is.numeric)) |> 
  colSums(na.rm = TRUE) 

```

Dieses Vorgehen ist hilfreich um bei veränderten Ergebnissen im Vergleich der Pipelines Unterschiede zu analysieren. Zur Dokumentation im Papier-basierten QM-System muss darüber hinaus aber ein Ausdruck zur handschriftlichen Unterschrift produziert werden. Dies geschieht mit folgender Funktionskette:

```{r echo=TRUE}
Re_Eval |> 
  tabulate_pipeline_QM() |>
  create_QMpdf_for_signatures()

```

Dieses PDF muss nun gedruckt und unterschrieben werden.
